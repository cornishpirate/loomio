<script lang="coffee">
import Records from '@/shared/services/records'
import Session from '@/shared/services/session'
import { Emoji } from 'emoji-mart-vue'
import {merge, capitalize, difference, keys, throttle, startsWith, each} from 'lodash'

export default
  props:
    model: Object
    load: Boolean

  components:
    Emoji: Emoji

  data: ->
    diameter: 20
    maxNamesCount: 10
    loaded: !@load
    reactionHash: {all: []}

  mounted: ->
    Records.view
      name: "reactionsTo#{@model.constructor.singular}#{@model.id}"
      collections: ['reactions']
      query: (store) =>
        @reactionHash = {all: []}
        each Records.reactions.find(@reactionParams), (reaction) =>
          name = reaction.user().name
          unless @reactionHash[reaction.reaction]?
            @reactionHash[reaction.reaction] = []
          @reactionHash[reaction.reaction].push(name)
          @reactionHash['all'].push(name)
          true

    if @load
      Records.reactions.fetch(params:
        reactable_type: capitalize(@model.constructor.singular)
        reactable_id: @model.id
      ).finally => @loaded = true


  computed:
    reactionParams: ->
      reactableType: capitalize(@model.constructor.singular)
      reactableId: @model.id

    reactionTypes: ->
      difference keys(@reactionHash), ['all']

    myReaction: ->
      return unless Session.isSignedIn()
      Records.reactions.find(merge({}, @reactionParams, userId: Session.user().id))[0]

    otherReaction: ->
      Records.reactions.find(merge({}, @reactionParams, {userId: {'$ne': Session.user().id}}))[0]

    reactionTypes: ->
      difference keys(@reactionHash), ['all']

  methods:
    removeMine: (reaction) ->
      mine = Records.reactions.find(merge({}, @reactionParams,
        userId:   Session.user().id
        reaction: reaction
      ))[0]
      mine.destroy() if mine

    translate: (shortname) ->
      title = emojiTitle(shortname)
      if startsWith(title, "reactions.") then shortname else title

    countFor: (reaction) ->
      if @reactionHash[reaction]?
        @reactionHash[reaction].length - @maxNamesCount
      else
        0

</script>
<template lang="pug">
.reactions-display.lmo-flex.lmo-flex__center
  loading(v-if="!loaded" :diameter="diameter")
  .lmo-flex.lmo-flex__center(v-if="loaded")
    .reactions-display__emojis
      .reaction.lmo-pointer(v-if="loaded" @click="removeMine(reaction)" v-for="reaction in reactionTypes")
        v-tooltip(bottom)
          template(v-slot:activator="{ on }")
            .fake-chip(v-on="on")
              emoji(:emoji="reaction" :size="diameter")
              span(v-if="reactionHash[reaction].length > 1") {{reactionHash[reaction].length}}
          .reactions-display__name(v-for="name in reactionHash[reaction]" :key="name") {{ name }}
    //- .reactions-display__names(v-iVjjjf="myReaction")
    //-   span(v-if="reactionHash.all.length == 1" v-t="'reactions_display.you'")
    //-   span(v-if="reactionHash.all.length == 2" v-t="{path: 'reactions_display.you_and_name', args: {name: otherReaction.user().name}}")
    //-   span(v-if="reactionHash.all.length > 2"  v-t="{path: 'reactions_display.you_and_name_and_count_more', args: {name: otherReaction.user().name, count: reactionHash.all.length - 2}}")
    //- .reactions-display__names(v-if="!myReaction")
    //-   span(v-if="reactionHash.all.length == 1") {{reactionHash.all[0]}}
    //-   span(v-if="reactionHash.all.length > 1" v-t="{path: 'reactions_display.name_and_count_more', args: {name: reactionHash.all[0], count: reactionHash.all.length - 1}}")
</template>

<style lang="scss">
.fake-chip {
  display: flex;
  align-items: center;
  margin-right: 2px;
}
.reactions-display__emojis {
  display: flex;
}
</style>
